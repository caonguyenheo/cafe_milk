<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<title>SimpleLink CC32xx OTA Library: OTA</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="slgen.css" rel="stylesheet" type="text/css"/>
<link href="slnavtree.css" rel="stylesheet" type="text/css"/>
<link href="sltabs.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="4" cellpadding="4">
 <tbody>
 <tr>
  <td id="projectlogo"><img alt="Logo" src="ti_logo.png" height="50px" /></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">SimpleLink CC32xx OTA Library
   </div>
   <div id="projectbrief">Simplifies the implementation of Internet connectivity</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___o_t_a.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#enumval-members">Enumerator</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">OTA</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga0dfcd395bf1bb26daff9a0e046bf129c"><td class="memItemLeft" align="right" valign="top">int16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___o_t_a.html#ga0dfcd395bf1bb26daff9a0e046bf129c">OTA_init</a> (OTA_runningMode runningMode, <a class="el" href="struct_o_t_a__mem_block.html">OTA_memBlock</a> *pMemBlock, OTA_eventHandler eventHandler)</td></tr>
<tr class="memdesc:ga0dfcd395bf1bb26daff9a0e046bf129c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the OTA application.  <a href="#ga0dfcd395bf1bb26daff9a0e046bf129c">More...</a><br /></td></tr>
<tr class="separator:ga0dfcd395bf1bb26daff9a0e046bf129c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga86ce4394cd2240d90aa2eb70dfbc58c6"><td class="memItemLeft" align="right" valign="top">int16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___o_t_a.html#ga86ce4394cd2240d90aa2eb70dfbc58c6">OTA_run</a> ()</td></tr>
<tr class="memdesc:ga86ce4394cd2240d90aa2eb70dfbc58c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Run the OTA App state machine.  <a href="#ga86ce4394cd2240d90aa2eb70dfbc58c6">More...</a><br /></td></tr>
<tr class="separator:ga86ce4394cd2240d90aa2eb70dfbc58c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9b76dab56b7831eaa50c8cc1f622ad40"><td class="memItemLeft" align="right" valign="top">int16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___o_t_a.html#ga9b76dab56b7831eaa50c8cc1f622ad40">OTA_set</a> (OTA_option option, int32_t optionLen, uint8_t *pOptionVal, int32_t flags)</td></tr>
<tr class="memdesc:ga9b76dab56b7831eaa50c8cc1f622ad40"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set OTA command/parameter.  <a href="#ga9b76dab56b7831eaa50c8cc1f622ad40">More...</a><br /></td></tr>
<tr class="separator:ga9b76dab56b7831eaa50c8cc1f622ad40"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf4bdeee052426ffad36def271c04d926"><td class="memItemLeft" align="right" valign="top">int16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___o_t_a.html#gaf4bdeee052426ffad36def271c04d926">OTA_get</a> (OTA_option option, int32_t *pOptionLen, uint8_t *pOptionVal)</td></tr>
<tr class="memdesc:gaf4bdeee052426ffad36def271c04d926"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the current OTA status.  <a href="#gaf4bdeee052426ffad36def271c04d926">More...</a><br /></td></tr>
<tr class="separator:gaf4bdeee052426ffad36def271c04d926"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ga51004ff3a02ebaa2e4e5d993ded6afae"><td class="memItemLeft" align="right" valign="top"><a id="ga51004ff3a02ebaa2e4e5d993ded6afae"></a>
uint8_t&#160;</td><td class="memItemRight" valign="bottom"><b>Buff</b> [OTA_BLOCK_SIZE]</td></tr>
<tr class="separator:ga51004ff3a02ebaa2e4e5d993ded6afae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga695da7bb44911784b82423e278357ea3"><td class="memItemLeft" align="right" valign="top"><a id="ga695da7bb44911784b82423e278357ea3"></a>
uint32_t&#160;</td><td class="memItemRight" valign="bottom"><b>IpAddress</b></td></tr>
<tr class="separator:ga695da7bb44911784b82423e278357ea3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf5baefd71526fa11ad4cf04a6aa45136"><td class="memItemLeft" align="right" valign="top"><a id="gaf5baefd71526fa11ad4cf04a6aa45136"></a>
uint32_t&#160;</td><td class="memItemRight" valign="bottom"><b>SecuredConnection</b></td></tr>
<tr class="separator:gaf5baefd71526fa11ad4cf04a6aa45136"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac333aba6039da601f01fcd3c16108baf"><td class="memItemLeft" align="right" valign="top"><a id="gac333aba6039da601f01fcd3c16108baf"></a>
uint8_t&#160;</td><td class="memItemRight" valign="bottom"><b>ServerName</b> [MAX_SERVER_NAME]</td></tr>
<tr class="separator:gac333aba6039da601f01fcd3c16108baf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga4b4f8f0b676bcbe7cb70543fd32490a1"><td class="memItemLeft" align="right" valign="top"><a id="ga4b4f8f0b676bcbe7cb70543fd32490a1"></a>
uint8_t&#160;</td><td class="memItemRight" valign="bottom"><b>VendorToken</b> [MAX_VENDOR_TOKEN_SIZE]</td></tr>
<tr class="separator:ga4b4f8f0b676bcbe7cb70543fd32490a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8dcd12a7d39a3137bf3084ae6d321e1a"><td class="memItemLeft" align="right" valign="top"><a id="ga8dcd12a7d39a3137bf3084ae6d321e1a"></a>
uint8_t&#160;</td><td class="memItemRight" valign="bottom"><b>CurrentVersion</b> [VERSION_STR_SIZE+1]</td></tr>
<tr class="separator:ga8dcd12a7d39a3137bf3084ae6d321e1a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac4d30a320dc14b826d970a9a7bddefb3"><td class="memItemLeft" align="right" valign="top"><a id="gac4d30a320dc14b826d970a9a7bddefb3"></a>
uint8_t&#160;</td><td class="memItemRight" valign="bottom"><b>NewVersion</b> [VERSION_STR_SIZE+1]</td></tr>
<tr class="separator:gac4d30a320dc14b826d970a9a7bddefb3"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h2 class="groupheader">Function Documentation</h2>
<a id="gaf4bdeee052426ffad36def271c04d926"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaf4bdeee052426ffad36def271c04d926">&sect;&nbsp;</a></span>OTA_get()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int16_t OTA_get </td>
          <td>(</td>
          <td class="paramtype">OTA_option&#160;</td>
          <td class="paramname"><em>option</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t *&#160;</td>
          <td class="paramname"><em>pOptionLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>pOptionVal</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get the current OTA status. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pOtaLib</td><td>OTA control block pointer </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">Option</td><td>Selects the option </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">OptionLen</td><td>option structure length </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pOptionVal</td><td>pointer to the option structure</td></tr>
  </table>
  </dd>
</dl>
<p>This function gets the current OTA of active or Idle. The parameter <em>option</em>, could be one of the following:</p>
<p><b>EXTLIB_OTA_GET_OPT_IS_ACTIVE</b> - Check if OTA process is active or idle <br />
<b>EXTLIB_OTA_GET_OPT_VERSIONS</b> - return the current OTA version and the new update version for the user to compare <br />
<b>EXTLIB_OTA_GET_OPT_IS_PENDING_COMMIT</b> - Check if the new image is in the state BUNDLE_STATE_WAITING_FOR_COMMIT <br />
 Value at <em>pOptionVal</em> will be set to 1 if OTA process is active, 0 if Idle</p>
<dl class="section return"><dt>Returns</dt><dd>Return 0 on success, -1 otherwise.</dd></dl>
<dl class="section see"><dt>See also</dt><dd></dd></dl>
<dl class="section note"><dt>Note</dt><dd></dd></dl>
<dl class="section warning"><dt>Warning</dt><dd></dd></dl>
<dl class="section user"><dt>Example: </dt><dd><div class="fragment"><div class="line">For example: check <span class="keywordflow">if</span> pending commit   </div><div class="line"></div><div class="line">int32_t isPendingCommit;</div><div class="line">int32_t isPendingCommit_len;</div><div class="line">int32_t Status;</div><div class="line"></div><div class="line">Status = Ota_get(EXTLIB_OTA_GET_OPT_IS_PENDING_COMMIT, &amp;isPendingCommit_len, (uint8_t *)&amp;isPendingCommit);</div></div><!-- fragment --> </dd></dl>

<p>Definition at line <a class="el" href="_ota_lib_8c_source.html#l00171">171</a> of file <a class="el" href="_ota_lib_8c_source.html">OtaLib.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;{</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <a class="code" href="struct_ota__opt_versions_info.html">Ota_optVersionsInfo</a> *pVersionsInfo;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    int16_t Status = OTA_STATUS_OK;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordflow">switch</span> (option)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    {</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_GET_OPT_IS_ACTIVE:</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            *(int32_t *)pOptionVal = (pOtaLib-&gt;State != OTA_STATE_IDLE);</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            *pOptionLen = <span class="keyword">sizeof</span>(int32_t);</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_GET_OPT_VERSIONS:</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        </div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;            pVersionsInfo = (<a class="code" href="struct_ota__opt_versions_info.html">Ota_optVersionsInfo</a> *)pOptionVal;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;            <span class="comment">/* get the current version from ota.dat file */</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            OtaArchive_getCurrentVersion(pVersionsInfo-&gt;CurrentVersion);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            <span class="comment">/* extract the new version from OtaFileName if exists */</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            <span class="keywordflow">if</span>(pOtaLib-&gt;pOtaFileName == NULL)</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;            {</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                <span class="comment">/* can be if the OTA not in the right state and still didn&#39;t read the file name */</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                <span class="comment">/* OTA file not exists (no upadte or state before reading the ota new update */</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                memset(pVersionsInfo-&gt;NewVersion, <span class="charliteral">&#39;0&#39;</span>, VERSION_STR_SIZE);</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;            }</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            {</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                uint8_t *pVersionFileName = _ExtractFileVersion(pOtaLib-&gt;pOtaFileName, MAX_CDN_FILE_NAME_SIZE);</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                <span class="comment">/* extract version from file */</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                memcpy(pVersionsInfo-&gt;NewVersion, pVersionFileName, VERSION_STR_SIZE);</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            }</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            pVersionsInfo-&gt;NewVersion[VERSION_STR_SIZE] = 0; <span class="comment">/* null terminated string */</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_GET_OPT_IS_PENDING_COMMIT:</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            *(int32_t *)pOptionVal = OtaArchive_getPendingCommit();</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_get: option %ld is not implemented\r\n&quot;</span>, option));</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;            Status = OTA_OPT_ERROR_OPTION_CODE;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    }</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;}</div><div class="ttc" id="struct_ota__opt_versions_info_html"><div class="ttname"><a href="struct_ota__opt_versions_info.html">Ota_optVersionsInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="ota_8h_source.html#l00081">ota.h:81</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ga0dfcd395bf1bb26daff9a0e046bf129c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga0dfcd395bf1bb26daff9a0e046bf129c">&sect;&nbsp;</a></span>OTA_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int16_t OTA_init </td>
          <td>(</td>
          <td class="paramtype">OTA_runningMode&#160;</td>
          <td class="paramname"><em>runningMode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_o_t_a__mem_block.html">OTA_memBlock</a> *&#160;</td>
          <td class="paramname"><em>pMemBlock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">OTA_eventHandler&#160;</td>
          <td class="paramname"><em>eventHandler</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the OTA application. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">runningMode</td><td>Supported only OTA_RUN_NON_BLOCKING </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pMemBlock</td><td>Is the OTA library control block allocated by the application </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eventHandler</td><td>Callback to the app, currently not supported, need to be NULL</td></tr>
  </table>
  </dd>
</dl>
<p>This function initializes the OTA application and modules. The size of the control block parameter <em>should</em> be enough for OTA init (currently 7800 bytes) otherwize the init will failed</p>
<dl class="section return"><dt>Returns</dt><dd>Return zero ot -ve otherwise.</dd></dl>
<p>-<b>OTA_INIT_ERROR</b> - when the size of the OTA control block OtaCB_t is not enough for the OTA lib <br />
 </p><dl class="section see"><dt>See also</dt><dd></dd></dl>
<dl class="section warning"><dt>Warning</dt><dd></dd></dl>
<dl class="section user"><dt>Example: </dt><dd><div class="fragment"><div class="line">For example: To initialize OTA from host invoke</div><div class="line"></div><div class="line"><a class="code" href="struct_o_t_a__mem_block.html">OTA_memBlock</a> otaMemBlock;</div><div class="line">int16_t Status;</div><div class="line">Status = <a class="code" href="group___o_t_a.html#ga0dfcd395bf1bb26daff9a0e046bf129c">OTA_init</a>(OTA_RUN_NON_BLOCKING, &amp;otaMemBlock, NULL);</div></div><!-- fragment --> </dd></dl>

<p>Definition at line <a class="el" href="_ota_lib_8c_source.html#l00045">45</a> of file <a class="el" href="_ota_lib_8c_source.html">OtaLib.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;{</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_init: sizeof CdnClient=%d, sizeof OtaArchive=%d\r\n&quot;</span>, <span class="keyword">sizeof</span>(pOtaLib-&gt;CdnClient), <span class="keyword">sizeof</span>(pOtaLib-&gt;OtaArchive)));</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_init: sizeof OtaLib_t=%d, sizeof OTA_memBlock=%d\r\n&quot;</span>, <span class="keyword">sizeof</span>(<a class="code" href="struct_ota_lib__t.html">OtaLib_t</a>), <span class="keyword">sizeof</span>(<a class="code" href="struct_o_t_a__mem_block.html">OTA_memBlock</a>)));</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(<a class="code" href="struct_ota_lib__t.html">OtaLib_t</a>) &gt; <span class="keyword">sizeof</span>(<a class="code" href="struct_o_t_a__mem_block.html">OTA_memBlock</a>))</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    {</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_init: ERROR buffer size OtaLib_t=%d &lt; OTA_memBlock=%d\r\n&quot;</span>, <span class="keyword">sizeof</span>(<a class="code" href="struct_ota_lib__t.html">OtaLib_t</a>), <span class="keyword">sizeof</span>(<a class="code" href="struct_o_t_a__mem_block.html">OTA_memBlock</a>)));</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        <span class="keywordflow">return</span> OTA_INIT_ERROR;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    }</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    pOtaLib = (<a class="code" href="struct_ota_lib__t.html">OtaLib_t</a> *)pMemBlock;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    memset(pOtaLib, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct_ota_lib__t.html">OtaLib_t</a>));</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    pOtaLib-&gt;State = OTA_STATE_IDLE;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_init: OTA lib version = %s\r\n&quot;</span>, OTA_LIB_VERSION));</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    CdnClient_Init(&amp;pOtaLib-&gt;CdnClient, pOtaLib-&gt;NetBuf);</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    OtaArchive_init(&amp;pOtaLib-&gt;OtaArchive);</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">/* init statistics */</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordflow">return</span> OTA_STATUS_OK;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;}</div><div class="ttc" id="struct_ota_lib__t_html"><div class="ttname"><a href="struct_ota_lib__t.html">OtaLib_t</a></div><div class="ttdef"><b>Definition:</b> <a href="_ota_lib_8h_source.html#l00059">OtaLib.h:59</a></div></div>
<div class="ttc" id="struct_o_t_a__mem_block_html"><div class="ttname"><a href="struct_o_t_a__mem_block.html">OTA_memBlock</a></div><div class="ttdef"><b>Definition:</b> <a href="ota_8h_source.html#l00054">ota.h:54</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ga86ce4394cd2240d90aa2eb70dfbc58c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga86ce4394cd2240d90aa2eb70dfbc58c6">&sect;&nbsp;</a></span>OTA_run()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int16_t OTA_run </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Run the OTA App state machine. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pOtaLib</td><td>Pointer to OTA application pointer</td></tr>
  </table>
  </dd>
</dl>
<p>Run one step from the OTA application state machine. Host should repeat calling this function and examine the return value in order to check if OTA completed or got error or just need to be continued. This pattern is useful in host with NON-OS. In host with OS, host should start OTA task and continuously calling this function till OTA completed.</p>
<dl class="section return"><dt>Returns</dt><dd>Return zero or +ve bitmap number on success, -ve otherwise.</dd></dl>
<p>-<b>OTA_RUN_STATUS_CONTINUE</b> - Host should continue calling sl_OtaRun <br />
-<b>OTA_RUN_STATUS_CONTINUE_WARNING_</b>... - group of OTA WARNINGS, actually those are errors but the OTA will retry the process 5 times so user should continue run the OTA <br />
-<b>OTA_RUN_STATUS_NO_UPDATES</b> - No updates for now, host can retry after another period of time<br />
-<b>OTA_RUN_STATUS_CHECK_NEWER_VERSION</b> - OTA found newer update version, user can accept the new version by calling sl_OtaSet with option _ ACCEPT_UPDATE , or just continue running, or do another check before continue <br />
-<b>OTA_RUN_STATUS_CHECK_OLDER_VERSION</b> - OTA found older update version, user can stop the OTA by calling sl_OtaSet with option _DECLINE_UPDATE , or continue running, or do another check before continue <br />
-<b>OTA_RUN_STATUS_DOWNLOAD_DONE</b> - Current OTA update completed, host should move the image to BUNDLE_STATE_TESTING by calling sl_Stop and then ro reset the MCU <br />
-<b>OTA_RUN_ERROR_</b>... - group of OTA ERRORS, user should stop the OTA process -<b>OTA_RUN_ERROR_CONSECUTIVE_OTA_ERRORS</b> - OTA process failed 5 consecutive times -<b>OTA_RUN_ERROR_NO_SERVER_NO_VENDOR</b> - user didn't call sl_OtaSet with EXTLIB_OTA_OPT_VENDOR_ID and EXTLIB_OTA_OPT_SERVER_INFO before running the OTA -<b>OTA_RUN_ERROR_SECURITY_ALERT</b> - security alert from file system, user must stop trying downloading current OTA update -<b>OTA_RUN_ERROR_UNEXPECTED_STATE</b> - OTA state error, must init the OTA before continue</p>
<dl class="section see"><dt>See also</dt><dd></dd></dl>
<dl class="section note"><dt>Note</dt><dd></dd></dl>
<dl class="section warning"><dt>Warning</dt><dd></dd></dl>
<dl class="section user"><dt>Example: </dt><dd><div class="fragment"><div class="line">For example: Run OTA from host   </div><div class="line"></div><div class="line">Status = Ota_run();</div></div><!-- fragment --> </dd></dl>

<p>Definition at line <a class="el" href="_ota_lib_8c_source.html#l00244">244</a> of file <a class="el" href="_ota_lib_8c_source.html">OtaLib.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;{</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <a class="code" href="struct_cdn_client__t.html">CdnClient_t</a> *pCdnClient = (<a class="code" href="struct_cdn_client__t.html">CdnClient_t</a> *)&amp;pOtaLib-&gt;CdnClient;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    int32_t NumDirFiles;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    int16_t Status;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    int16_t ProcessedBytes;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    uint8_t *pVersionFileName;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    switch (pOtaLib-&gt;State)</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    {</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_IDLE:</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;            <span class="comment">/* serverInfo and vendorDir must be init before running OTA */</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="keywordflow">if</span> ((pOtaLib-&gt;OtaServerInfo.ServerName[0] == 0) <span class="comment">/*|| (pOtaLib-&gt;VendorDir[0] == 0)*/</span>)</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            {</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                <span class="keywordflow">return</span> OTA_RUN_ERROR_NO_SERVER_NO_VENDOR;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            }</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            pOtaLib-&gt;State = OTA_STATE_CONNECT_SERVER;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_CONNECT_SERVER:</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: call CdnClient_ConnectServer OTA server=%s\r\n&quot;</span>, pOtaLib-&gt;OtaServerInfo.ServerName));</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            Status = CdnClient_ConnectServer(pCdnClient, &amp;pOtaLib-&gt;OtaServerInfo);</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            <span class="keywordflow">if</span>( Status &lt; 0)</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            {</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR CdnClient_ConnectServer, Status=%ld\r\n&quot;</span>, Status));</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                Status = _OtaCheckConsecutiveErrors(pOtaLib, OTA_RUN_STATUS_CONTINUE_WARNING_FAILED_CONNECT_FILE_SERVER, BACK_TO_IDLE);</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            }</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            pOtaLib-&gt;State = OTA_STATE_REQ_OTA_DIR;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_REQ_OTA_DIR:</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: CdnClient_ReqOtaDir, VendorDir=%s\r\n&quot;</span>, pOtaLib-&gt;VendorDir));</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;            NumDirFiles = CdnClient_ReqOtaDir(pCdnClient, pOtaLib-&gt;VendorDir);</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            <span class="keywordflow">if</span> (NumDirFiles &lt; 0)</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            {</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR CdnClient_ReqOtaDir, Status=%d\r\n&quot;</span>, NumDirFiles));</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                Status = _OtaCheckConsecutiveErrors(pOtaLib, OTA_RUN_STATUS_CONTINUE_WARNING_FAILED_REQ_OTA_DIR, BACK_TO_IDLE);</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            }</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            <span class="keywordflow">if</span> (NumDirFiles == 0)</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            {</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR CdnClient_ReqOtaDir - no updates\r\n&quot;</span>));</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                pOtaLib-&gt;ConsecutiveOtaErrors = 0;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                pOtaLib-&gt;State = OTA_STATE_IDLE;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                _OtaCleanToIdle(pOtaLib);</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                <span class="keywordflow">return</span> OTA_RUN_STATUS_NO_UPDATES;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            }</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: CdnClient_ReqOtaDir, NumDirFiles=%ld\r\n&quot;</span>, NumDirFiles));</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            pOtaLib-&gt;State = OTA_STATE_CHECK_ARCHIVE_NEW_UPDATE;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_CHECK_ARCHIVE_NEW_UPDATE:</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: CdnClient_GetNextDirFile\r\n&quot;</span>));</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            pOtaLib-&gt;pOtaFileName = CdnClient_GetNextDirFile(pCdnClient, &amp;pOtaLib-&gt;OtaFileSize);</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            <span class="comment">/* check if last file in the list, still without tar file */</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            <span class="keywordflow">if</span>( pOtaLib-&gt;pOtaFileName == NULL)</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            {</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                <span class="comment">/* tar file not found, return no updates */</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR CdnClient_ReqOtaDir - tar not found, no updates\r\n&quot;</span>));</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                pOtaLib-&gt;ConsecutiveOtaErrors = 0;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                pOtaLib-&gt;State = OTA_STATE_IDLE;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                _OtaCleanToIdle(pOtaLib);</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                <span class="keywordflow">return</span> OTA_RUN_STATUS_NO_UPDATES;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            }</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: CdnClient_GetNextDirFile: file=%s, size=%ld\r\n&quot;</span>, pOtaLib-&gt;pOtaFileName, pOtaLib-&gt;OtaFileSize));</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            <span class="keywordflow">if</span> (strstr((<span class="keyword">const</span> <span class="keywordtype">char</span> *)pOtaLib-&gt;pOtaFileName, <span class="stringliteral">&quot;.tar&quot;</span>) == NULL) </div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;            {</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: WARNING, not a tar file, filename=%s\r\n&quot;</span>, pOtaLib-&gt;pOtaFileName));</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                <span class="comment">/* Stay on state, check next file version */</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                pOtaLib-&gt;State = OTA_STATE_CHECK_ARCHIVE_NEW_UPDATE;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                <span class="keywordflow">return</span> OTA_RUN_STATUS_CONTINUE;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            }</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            <span class="comment">/* continue anyway, user app can override this decision */</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            pOtaLib-&gt;State = OTA_STATE_REQ_FILE_URL;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            <span class="comment">/* Init the Tar parser module */</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            OtaArchive_init(&amp;pOtaLib-&gt;OtaArchive);</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            <span class="comment">/* host should check the version */</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            pVersionFileName = _ExtractFileVersion(pOtaLib-&gt;pOtaFileName, MAX_CDN_FILE_NAME_SIZE);</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            <span class="keywordflow">if</span> (OtaArchive_checkVersion(&amp;pOtaLib-&gt;OtaArchive, pVersionFileName))</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            {</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <span class="keywordflow">return</span> OTA_RUN_STATUS_CHECK_NEWER_VERSION;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            }</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            {</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                <span class="keywordflow">return</span> OTA_RUN_STATUS_CHECK_OLDER_VERSION;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            }</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_REQ_FILE_URL:</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: Call CdnClient_ReqFileUrl, filename = %s\r\n&quot;</span>, pOtaLib-&gt;pOtaFileName));</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            Status = CdnClient_ReqFileUrl(pCdnClient, pOtaLib-&gt;pOtaFileName, pOtaLib-&gt;FileUrlBuf, <span class="keyword">sizeof</span>(pOtaLib-&gt;FileUrlBuf));</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            <span class="keywordflow">if</span>( Status &lt; 0)</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            {</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR CdnClient_ReqFileUrl, Status=%d\r\n&quot;</span>, Status));</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                Status = _OtaCheckConsecutiveErrors(pOtaLib, OTA_RUN_STATUS_CONTINUE_WARNING_FAILED_REQ_FILE_URL, BACK_TO_IDLE);</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            }</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;            <span class="comment">/* In this stage the CDN server can be closed */</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;            CdnClient_CloseServer(&amp;pOtaLib-&gt;CdnClient);</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            pOtaLib-&gt;State = OTA_STATE_CONNECT_FILE_SERVER;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_CONNECT_FILE_SERVER:</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: Call CdnClient_ConnectFileServer, url = %s\r\n&quot;</span>, pOtaLib-&gt;FileUrlBuf));</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;            Status = CdnClient_ConnectFileServer(&amp;pOtaLib-&gt;CdnClient, pOtaLib-&gt;FileUrlBuf, pOtaLib-&gt;OtaServerInfo.SecuredConnection);</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            <span class="keywordflow">if</span>( Status &lt; 0)</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            {</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                <span class="comment">/* stay on this state for another retry */</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR CdnClient_ConnectFileServer, Status=%d\r\n&quot;</span>, Status));</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                Status = _OtaCheckConsecutiveErrors(pOtaLib, OTA_RUN_STATUS_CONTINUE_WARNING_FAILED_CONNECT_FILE_SERVER, BACK_TO_IDLE);</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            }</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            pOtaLib-&gt;State = OTA_STATE_REQ_FILE_CONTENT;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_REQ_FILE_CONTENT:</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: Call CdnClient_ReqFileContent, url = %s\r\n&quot;</span>, pOtaLib-&gt;FileUrlBuf));</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            Status = CdnClient_ReqFileContent(&amp;pOtaLib-&gt;CdnClient, pOtaLib-&gt;FileUrlBuf);</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;            <span class="keywordflow">if</span>( Status &lt; 0)</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;            {</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR CdnClient_ReqFileContent, Status=%d\r\n&quot;</span>, Status));</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                Status = _OtaCheckConsecutiveErrors(pOtaLib, OTA_RUN_STATUS_CONTINUE_WARNING_FAILED_REQ_FILE_CONTENT, BACK_TO_IDLE);</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            }</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            pOtaLib-&gt;State = OTA_STATE_PREPARE_DOWNLOAD;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_PREPARE_DOWNLOAD:</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            <span class="comment">/* prepare receive buffer */</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;            pOtaLib-&gt;pRecvChunk = pOtaLib-&gt;NetBuf;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            pOtaLib-&gt;RecvChunkOffset = 0;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            pOtaLib-&gt;RecvChunkForceReadMode = 0;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;            pOtaLib-&gt;RecvChunkSize = CdnClient_RecvSkipHdr(pCdnClient-&gt;FileSockId, pOtaLib-&gt;pRecvChunk, NET_BUF_SIZE);</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;            <span class="keywordflow">if</span> (0 &gt;= pOtaLib-&gt;RecvChunkSize)</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;            {</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR downloading, CdnClient_RecvSkipHdr Status=%ld\r\n&quot;</span>, pOtaLib-&gt;RecvChunkSize));</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                <span class="comment">/* Stop the parsing of the archive file */</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                OtaArchive_abort(&amp;pOtaLib-&gt;OtaArchive);</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                Status = _OtaCheckConsecutiveErrors(pOtaLib, OTA_RUN_STATUS_CONTINUE_WARNING_FAILED_FILE_HDR, BACK_TO_IDLE);</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;            }</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            pOtaLib-&gt;State = OTA_STATE_DOWNLOADING; </div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_DOWNLOADING:</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            <span class="comment">/* Check if to read more chunk */</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            <span class="keywordflow">if</span> ((pOtaLib-&gt;RecvChunkOffset != 0) || (pOtaLib-&gt;RecvChunkSize == 0) || pOtaLib-&gt;RecvChunkForceReadMode)</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;            {</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                int16_t UnprocessedSize = pOtaLib-&gt;RecvChunkSize-pOtaLib-&gt;RecvChunkOffset;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                int16_t Len;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                <span class="keywordflow">if</span> (UnprocessedSize &gt;= TAR_HDR_SIZE)</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                {</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                    <span class="comment">/* No need to read more, enough unprocessed bytes to decode next TAR file header */</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                    memcpy(&amp;pOtaLib-&gt;pRecvChunk[0], &amp;pOtaLib-&gt;pRecvChunk[pOtaLib-&gt;RecvChunkOffset], UnprocessedSize);</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                    Len = UnprocessedSize;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                }</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                {</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                    Len = CdnClient_RecvAppend(pCdnClient-&gt;FileSockId, pOtaLib-&gt;pRecvChunk, NET_BUF_SIZE, pOtaLib-&gt;RecvChunkSize, pOtaLib-&gt;RecvChunkOffset);</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                }</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                <span class="keywordflow">if</span> (0 &gt;= Len)</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                {</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                    _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR downloading, CdnClient_RecvAppend Status=%ld\r\n&quot;</span>, Len));</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                    <span class="comment">/* Stop the parsing of the archive file */</span>  </div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                    OtaArchive_abort(&amp;pOtaLib-&gt;OtaArchive);</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                    Status = _OtaCheckConsecutiveErrors(pOtaLib, OTA_RUN_STATUS_CONTINUE_WARNING_FAILED_RECV_APPEND, BACK_TO_IDLE);</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                    <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                }</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                pOtaLib-&gt;RecvChunkOffset = 0;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                pOtaLib-&gt;RecvChunkSize = Len;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                pOtaLib-&gt;RecvChunkForceReadMode = 0;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;            }</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            Status = OtaArchive_process(&amp;pOtaLib-&gt;OtaArchive, pOtaLib-&gt;pRecvChunk, pOtaLib-&gt;RecvChunkSize, &amp;ProcessedBytes);</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            pOtaLib-&gt;RecvChunkForceReadMode = (Status == ARCHIVE_STATUS_FORCE_READ_MORE);</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            pOtaLib-&gt;RecvChunkOffset += ProcessedBytes;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            <span class="keywordflow">if</span>( Status &lt; 0)</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            {</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                <span class="keywordflow">if</span> (Status == ARCHIVE_STATUS_ERROR_SECURITY_ALERT)</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                {</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                    _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: SECURITY ALERT OtaArchive_RunParse, Status=%d\r\n&quot;</span>, Status));</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                    <span class="comment">/* On SECURITY ALERT, stop all, no consecutive errors check */</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                    pOtaLib-&gt;State = OTA_STATE_IDLE;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                    _OtaCleanToIdle(pOtaLib);</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                    Status = OTA_RUN_ERROR_SECURITY_ALERT;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                }</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                {</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                    _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ERROR OtaArchive_RunParse, Status=%d\r\n&quot;</span>, Status));</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                    Status = _OtaCheckConsecutiveErrors(pOtaLib, OTA_RUN_STATUS_CONTINUE_WARNING_FAILED_DOWNLOAD_AND_SAVE, BACK_TO_IDLE);</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                }</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            }</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Status == ARCHIVE_STATUS_DOWNLOAD_DONE)</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            {</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_run: ---- Download file completed %s\r\n&quot;</span>, pOtaLib-&gt;pOtaFileName));</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                CdnClient_CloseFileServer(&amp;pOtaLib-&gt;CdnClient);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                pOtaLib-&gt;State = OTA_STATE_WAIT_CONFIRM; <span class="comment">/* not real state, cannot go to idle, user app should reset */</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                pOtaLib-&gt;ConsecutiveOtaErrors = 0;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                <span class="keywordflow">return</span> OTA_RUN_STATUS_DOWNLOAD_DONE;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;            }</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="keywordflow">case</span> OTA_STATE_WAIT_CONFIRM:</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;            <span class="comment">/* not real state, cannot go to idle, user app should reset */</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;sl_OtaRun ERROR: unexpected state %d\r\n&quot;</span>, pOtaLib-&gt;State));</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;            <span class="keywordflow">return</span> OTA_RUN_STATUS_DOWNLOAD_DONE;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;sl_OtaRun ERROR: unexpected state %d\r\n&quot;</span>, pOtaLib-&gt;State));</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;            <span class="keywordflow">return</span> OTA_RUN_ERROR_UNEXPECTED_STATE;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    }</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keywordflow">return</span> OTA_RUN_STATUS_CONTINUE;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;}</div><div class="ttc" id="struct_cdn_client__t_html"><div class="ttname"><a href="struct_cdn_client__t.html">CdnClient_t</a></div><div class="ttdef"><b>Definition:</b> <a href="_cdn_client_8h_source.html#l00054">CdnClient.h:54</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ga9b76dab56b7831eaa50c8cc1f622ad40"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga9b76dab56b7831eaa50c8cc1f622ad40">&sect;&nbsp;</a></span>OTA_set()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int16_t OTA_set </td>
          <td>(</td>
          <td class="paramtype">OTA_option&#160;</td>
          <td class="paramname"><em>option</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>optionLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>pOptionVal</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set OTA command/parameter. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pOtaLib</td><td>OTA control block pointer </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">Option</td><td>Select the option </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">OptionLen</td><td>Option structure length </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pOptionVal</td><td>pointer to the option structure</td></tr>
  </table>
  </dd>
</dl>
<p>This function sets OTA command/parameter. The parameter <em>Option</em> can be one of the following:</p>
<p><b>EXTLIB_OTA_SET_OPT_SERVER_INFO</b> - Set the Server information <br />
<b>EXTLIB_OTA_SET_OPT_VENDOR_ID</b> - Set the Vendor DIR string <br />
<b>EXTLIB_OTA_SET_OPT_ACCEPT_UPDATE</b> - Accept the new image <br />
<b>EXTLIB_OTA_SET_OPT_DECLINE_UPDATE</b> - Decline the new image <br />
<b>EXTLIB_OTA_SET_OPT_IMAGE_COMMIT</b> - Commit the currnet image in testing mode <br />
<b>EXTLIB_OTA_SET_OPT_IMAGE_ROLLBACK</b> - decline the currnet image in testing mode and rollback to the previous image <br />
 </p><dl class="section return"><dt>Returns</dt><dd>On success, zero is returned. On error, -1 is returned</dd></dl>
<dl class="section see"><dt>See also</dt><dd></dd></dl>
<dl class="section note"><dt>Note</dt><dd></dd></dl>
<dl class="section warning"><dt>Warning</dt><dd></dd></dl>
<dl class="section user"><dt>Example: </dt><dd><div class="fragment"><div class="line">For example: Set OTA server info from host   </div><div class="line"></div><div class="line"><a class="code" href="struct_ota__opt_server_info.html">Ota_optServerInfo</a> g_otaOptServerInfo;</div><div class="line"></div><div class="line">g_otaOptServerInfo.IpAddress         = OTA_SERVER_IP_ADDRESS;</div><div class="line">g_otaOptServerInfo.SecuredConnection = OTA_SERVER_SECURED;</div><div class="line">strcpy((<span class="keywordtype">char</span> *)g_otaOptServerInfo.ServerName,  OTA_SERVER_NAME);</div><div class="line">strcpy((<span class="keywordtype">char</span> *)g_otaOptServerInfo.VendorToken, OTA_VENDOR_TOKEN);</div><div class="line">Status = Ota_set(EXTLIB_OTA_SET_OPT_SERVER_INFO, <span class="keyword">sizeof</span>(g_otaOptServerInfo), (uint8_t *)&amp;g_otaOptServerInfo);</div><div class="line"></div><div class="line">Ota_set(EXTLIB_OTA_SET_OPT_SERVER_INFO, <span class="keyword">sizeof</span>(g_otaOptServerInfo), (uint8_t *)&amp;g_otaOptServerInfo, 0);</div></div><!-- fragment --> </dd></dl>

<p>Definition at line <a class="el" href="_ota_lib_8c_source.html#l00099">99</a> of file <a class="el" href="_ota_lib_8c_source.html">OtaLib.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;{</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    int16_t Status = OTA_STATUS_OK;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordflow">switch</span> (option)</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    {</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_SET_OPT_SERVER_INFO:</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            memcpy(&amp;pOtaLib-&gt;OtaServerInfo, pOptionVal, <span class="keyword">sizeof</span>(<a class="code" href="struct_ota__opt_server_info.html">Ota_optServerInfo</a>));</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_SET_OPT_VENDOR_ID:</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            <span class="keywordflow">if</span> (strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *)pOptionVal) &gt;= MAX_VENDIR_DIR_SIZE)</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            {</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                <span class="keywordflow">return</span> OTA_OPT_ERROR_VENDOR_DIR_SIZE;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;            }</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            strcpy((<span class="keywordtype">char</span> *)pOtaLib-&gt;VendorDir, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)pOptionVal);</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_SET_OPT_ACCEPT_UPDATE:</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="comment">/* do nothing, the OTA is already on process and not in IDLE state */</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_SET_OPT_DECLINE_UPDATE:</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            <span class="comment">/* check if after OTA_STATE_CHECK_ARCHIVE_NEW_UPDATE state */</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            <span class="keywordflow">if</span> (pOtaLib-&gt;State != OTA_STATE_REQ_FILE_URL)</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            {</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_set: ERROR EXTLIB_OTA_SET_OPT_DECLINE_UPDATE in wrong state = %d\r\n&quot;</span>, pOtaLib-&gt;State));</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                <span class="keywordflow">return</span> OTA_OPT_ERROR_WRONG_STATE;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            }</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            <span class="comment">/* close all connection from last OTA updates and back to IDLE */</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            pOtaLib-&gt;ConsecutiveOtaErrors = 0;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;            _OtaCleanToIdle(pOtaLib);</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_SET_OPT_IMAGE_COMMIT:</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            Status = OtaArchive_commit();</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            <span class="keywordflow">if</span> (Status &lt; 0)</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            {</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_set: ERROR OtaArchive_Commit, status=%d\r\n&quot;</span>, Status));</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                <span class="keywordflow">return</span> OTA_OPT_ERROR_COMMIT;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;            }</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="keywordflow">case</span> EXTLIB_OTA_SET_OPT_IMAGE_ROLLBACK:</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            Status = OtaArchive_rollback();</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;            <span class="keywordflow">if</span> (Status &lt; 0)</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            {</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                <span class="keywordflow">if</span> (Status == SL_ERROR_FS_BUNDLE_NOT_IN_CORRECT_STATE)</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                {</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                    _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_set: ERROR OtaArchive_Rollback, status=%d - ignored SL_ERROR_FS_BUNDLE_NOT_IN_CORRECT_STATE\r\n&quot;</span>, Status));</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                    <span class="comment">/* Ignore error calling rollback in the incorrect state */</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                    <span class="keywordflow">return</span> OTA_STATUS_OK;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                }</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_set: ERROR OtaArchive_Rollback, status=%d\r\n&quot;</span>, Status));</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                <span class="keywordflow">return</span> OTA_OPT_ERROR_ROLLBACK;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            }</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            _SlOtaLibTrace((<span class="stringliteral">&quot;OTA_set: option %ld is not implemented\r\n&quot;</span>, option));</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            <span class="keywordflow">return</span> OTA_OPT_ERROR_OPTION_CODE;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    }</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keywordflow">return</span> Status;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;}</div><div class="ttc" id="struct_ota__opt_server_info_html"><div class="ttname"><a href="struct_ota__opt_server_info.html">Ota_optServerInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="ota_8h_source.html#l00073">ota.h:73</a></div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ga51004ff3a02ebaa2e4e5d993ded6afae"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga51004ff3a02ebaa2e4e5d993ded6afae">&sect;&nbsp;</a></span>Buff</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t Buff[OTA_BLOCK_SIZE]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="ota_8h_source.html#l00056">56</a> of file <a class="el" href="ota_8h_source.html">ota.h</a>.</p>

</div>
</div>
<a id="ga8dcd12a7d39a3137bf3084ae6d321e1a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga8dcd12a7d39a3137bf3084ae6d321e1a">&sect;&nbsp;</a></span>CurrentVersion</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t CurrentVersion[VERSION_STR_SIZE+1]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="ota_8h_source.html#l00083">83</a> of file <a class="el" href="ota_8h_source.html">ota.h</a>.</p>

</div>
</div>
<a id="ga695da7bb44911784b82423e278357ea3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga695da7bb44911784b82423e278357ea3">&sect;&nbsp;</a></span>IpAddress</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t IpAddress</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="ota_8h_source.html#l00075">75</a> of file <a class="el" href="ota_8h_source.html">ota.h</a>.</p>

</div>
</div>
<a id="gac4d30a320dc14b826d970a9a7bddefb3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gac4d30a320dc14b826d970a9a7bddefb3">&sect;&nbsp;</a></span>NewVersion</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t NewVersion[VERSION_STR_SIZE+1]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="ota_8h_source.html#l00084">84</a> of file <a class="el" href="ota_8h_source.html">ota.h</a>.</p>

</div>
</div>
<a id="gaf5baefd71526fa11ad4cf04a6aa45136"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaf5baefd71526fa11ad4cf04a6aa45136">&sect;&nbsp;</a></span>SecuredConnection</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t SecuredConnection</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="ota_8h_source.html#l00076">76</a> of file <a class="el" href="ota_8h_source.html">ota.h</a>.</p>

</div>
</div>
<a id="gac333aba6039da601f01fcd3c16108baf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gac333aba6039da601f01fcd3c16108baf">&sect;&nbsp;</a></span>ServerName</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t ServerName[MAX_SERVER_NAME]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="ota_8h_source.html#l00077">77</a> of file <a class="el" href="ota_8h_source.html">ota.h</a>.</p>

</div>
</div>
<a id="ga4b4f8f0b676bcbe7cb70543fd32490a1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga4b4f8f0b676bcbe7cb70543fd32490a1">&sect;&nbsp;</a></span>VendorToken</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t VendorToken[MAX_VENDOR_TOKEN_SIZE]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="ota_8h_source.html#l00078">78</a> of file <a class="el" href="ota_8h_source.html">ota.h</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
